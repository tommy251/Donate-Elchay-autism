document.getElementById('donationForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const amount = document.getElementById('amount').value;
    const message = document.getElementById('message');

    // Send request to backend to initialize payment
    fetch('/pay', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'name': name,
            'email': email,
            'amount': amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const authorizationUrl = data.data.authorization_url;
            const reference = data.data.reference;

            // Open Paystack payment popup
            const handler = PaystackPop.setup({
                key: paystackKey,
                email: email,
                amount: amount * 100,
                ref: reference,
                onClose: function () {
                    message.textContent = 'Payment window closed.';
                },
                callback: function (response) {
                    // Verify payment on the backend with name, email, and amount
                    fetch(`/verify/${response.reference}?name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&amount=${amount}`)
                        .then(res => res.json())
                        .then(verifyData => {
                            if (verifyData.status === 'success') {
                                message.textContent = 'Payment successful! Thank you for your donation, ' + name + '!';
                                message.style.color = '#2ecc71';
                            } else {
                                message.textContent = 'Payment verification failed.';
                            }
                        });
                }
            });
            handler.openIframe();
        } else {
            message.textContent = 'Error initializing payment. Please try again.';
        }
    })
    .catch(error => {
        message.textContent = 'An error occurred. Please try again.';
        console.error('Error:', error);
    });
});